<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>818å¯èˆªç››å…¸æ‰“å¡ç›²ç›’ Â· 818 Grand Launch Â· Check-in Mystery Box</title>
  <meta name="description" content="818å¯èˆªç››å…¸æ‰“å¡ç›²ç›’ Â· 700æ¬¡ Â· è§¦å‘ç‚¹æ¦‚ç‡é€’å¢ Â· çª—å£æœ«å¿…å‡º" />
  <style>
    :root { --overlay: rgba(170, 24, 24, .58); --overlay2: rgba(255, 92, 0, .38); }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue','Noto Sans',Arial;
      color:#fff;
      background: url('bg818.png') center/cover no-repeat fixed;
      position: relative; min-height: 100vh;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 50% 30%, var(--overlay2), rgba(0,0,0,0) 70%),
        linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.55) 30%, rgba(0,0,0,.75));
      pointer-events:none; z-index:-1;
    }
    header{ padding: 28px 16px 12px; text-align:center; text-shadow: 0 2px 12px rgba(0,0,0,.45); }
    h1{ margin:0; font-size: clamp(24px, 4vw, 40px); font-weight:800; letter-spacing: .5px;}
    .subtitle{ margin-top:6px; color:#ffd7a8; font-size: clamp(12px, 2.2vw, 16px); }
    .container{ max-width: 960px; margin: 0 auto; padding: 16px; }
    .panel{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: 14px; padding: 18px;
      backdrop-filter: blur(4px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .form-box input{ width:260px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.35); color:#fff; margin:6px; }
    .form-box button{
      padding: 10px 20px; font-size: 18px;
      background: linear-gradient(135deg,#ff7a00,#ffb703); color:#1a1a1a; border:none; border-radius:10px; cursor:pointer; margin-top:10px;
      box-shadow: 0 6px 18px rgba(255,122,0,.35);
    }
    .box{ width: 240px; height: 240px; margin:24px auto 0; border-radius:18px;
      background: url('mang he.png') center/cover no-repeat;
      box-shadow: 0 12px 36px rgba(0,0,0,.45);
    }
    .shake { animation: shake 900ms ease-in-out; }
    @keyframes shake {
      0%{transform:translate(0,0) rotate(0deg)}
      10%{transform:translate(-8px,6px) rotate(-5deg)}
      20%{transform:translate(8px,-6px) rotate(5deg)}
      30%{transform:translate(-10px,8px) rotate(-6deg)}
      40%{transform:translate(10px,-8px) rotate(6deg)}
      50%{transform:translate(-6px,6px) rotate(-4deg)}
      60%{transform:translate(6px,-6px) rotate(4deg)}
      70%{transform:translate(-4px,4px) rotate(-3deg)}
      80%{transform:translate(4px,-4px) rotate(3deg)}
      100%{transform:translate(0,0) rotate(0deg)}
    }
    #result{max-height:360px;overflow:auto;margin-top:12px;display:flex;flex-direction:column;gap:6px}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .muted{opacity:.7;font-size:12px}
    .debug{font-size:12px;opacity:.8;margin-top:8px;text-align:center}
    .debug input{vertical-align:middle}
  </style>
</head>
<body>
  <header>
    <h1>818å¯èˆªç››å…¸æ‰“å¡ç›²ç›’</h1>
    <div class="subtitle">818 Grand Launch Â· Check-in Mystery Box</div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="form-box" style="text-align:center">
        <div class="row">
          <input type="text" id="userID" placeholder="è¯·è¾“å…¥æ‚¨çš„IDå· (ZMYXXXXXXXX)" />
          <input type="email" id="email" placeholder="ï¼ˆå¯é€‰ï¼‰è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ / Optional email" />
          <input type="number" id="chances" placeholder="è¯·è¾“å…¥æŠ½å¥–æ¬¡æ•° / Draws" min="1" value="1" />
        </div>
        <div class="row" style="margin-top:8px">
          <button onclick="startDraws()">å¼€å§‹æŠ½å¥– / Start</button>
          <button onclick="exportToCSV()">å¯¼å‡ºæŠ½å¥–æ•°æ® CSV</button>
        </div>
        <div class="box" id="box" title="ç‚¹å‡»å¼€å§‹æŠ½å¥– / Click Start"></div>
        <div id="result"></div>
        <div class="debug">
          <label><input type="checkbox" id="debugMode"> æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ / Debug logs</label>
          <div id="lastStatus"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Google Sheets Web App URL =====
  const googleScriptURL = "https://script.google.com/macros/s/AKfycbzD5aJHsRxsaPdjMAR7_LY4DugNZhold9iP3dx6OmP_CP4xROB21U0xlRIWqI1bs8V3/exec";

  // ===== å¥–æ± é€»è¾‘ï¼šè§¦å‘ç‚¹ + æ¦‚ç‡é€’å¢ + çª—å£æœ«å¿…å‡º =====
  const CONFIG = {
    total: 700, // æ€»æŠ½æ•°é™åˆ¶
    labels: {
      G1: "RM999 è‚©è†€æŒ‰æ‘©ä»ª / The Euphoria Essential Massager",
      G2: "RM5"
    },
    // æ¦‚ç‡å‚æ•°ï¼ˆå¯æŒ‰éœ€è¦å¾®è°ƒï¼‰
    baseProb: 0.12,  // è¿›å…¥è§¦å‘ç‚¹åçš„èµ·å§‹å‘½ä¸­ç‡
    stepProb: 0.08,  // æ¯å¤šæŠ½1æ¬¡çš„é€’å¢
    maxProb: 0.90,   // å•æ¬¡å‘½ä¸­ç‡ä¸Šé™
    triggers: (function(){ const arr=[5]; for(let n=50;n<=700;n+=50) arr.push(n); return arr; })()
  };

  let globalDrawCount = 0;
  const drawRecords = [];
  let windowIndex = 0; // å½“å‰è§¦å‘çª—å£ç´¢å¼•
  const windowHit = Array(CONFIG.triggers.length).fill(false); // æ¯çª—å£æ˜¯å¦å·²å‡ºG1

  function shakeBox() {
    const box = document.getElementById('box');
    box.classList.remove('shake'); // reset
    void box.offsetWidth;          // force reflow
    box.classList.add('shake');    // play
  }

  function startDraws() {
    const userID = document.getElementById("userID").value.trim();
    const chances = parseInt(document.getElementById("chances").value.trim());
    if (!userID || isNaN(chances) || chances < 1) {
      alert("è¯·è¾“å…¥IDå·ï¼Œå¹¶ç¡®ä¿æŠ½å¥–æ¬¡æ•° â‰¥ 1ï¼ / Please input ID and a valid number of draws (â‰¥1).");
      return;
    }
    if (globalDrawCount >= CONFIG.total) {
      alert("å·²è¾¾åˆ° 700 æ¬¡ä¸Šé™");
      return;
    }
    drawLoop(chances, userID);
  }

  function nextTrigger(i){ return (i+1 < CONFIG.triggers.length) ? CONFIG.triggers[i+1] : (CONFIG.total + 1); }

  function drawLoop(left, userID){
    if (left <= 0 || globalDrawCount >= CONFIG.total) return;
    shakeBox();
    // ç­‰åŠ¨ç”»ç»“æŸåå†åˆ¤å®šç»“æœ
    setTimeout(()=>{ performDraw(userID); if (left > 1) setTimeout(()=>drawLoop(left-1, userID), 200); }, 920);
  }

  function performDraw(userID) {
    globalDrawCount++;

    // å¦‚æœè¿›å…¥äº†ä¸‹ä¸€ä¸ªè§¦å‘ç‚¹ï¼Œå¯¹é½çª—å£ç´¢å¼•
    while (windowIndex < CONFIG.triggers.length - 1 && globalDrawCount >= CONFIG.triggers[windowIndex + 1]) {
      windowIndex++;
    }

    const trig = CONFIG.triggers[windowIndex];
    const nextTrig = nextTrigger(windowIndex);
    let prize = CONFIG.labels.G2; // é»˜è®¤ RM5

    // åœ¨è§¦å‘çª—å£å†…çš„æ¦‚ç‡åˆ¤å®š
    if (!windowHit[windowIndex] && globalDrawCount >= trig) {
      const inWindowIndex = globalDrawCount - trig; // åœ¨è¯¥çª—å£å†…å·²è¿›è¡Œçš„æ¬¡æ•°ï¼ˆä»0å¼€å§‹ï¼‰
      const isLastChanceBeforeNext = (globalDrawCount === nextTrig - 1) || (globalDrawCount === CONFIG.total);
      let p = Math.min(CONFIG.baseProb + inWindowIndex * CONFIG.stepProb, CONFIG.maxProb);
      if (isLastChanceBeforeNext) p = 1.0; // çª—å£æœ«å¿…å‡ºä¸€æ¬¡
      if (Math.random() < p) { prize = CONFIG.labels.G1; windowHit[windowIndex] = true; }
    }

    const now = new Date();
    const gmt8Time = new Date(now.getTime() + 8 * 3600000).toISOString().replace('T',' ').split('.')[0] + ' GMT+8';

    const record = { userID, prize, time: gmt8Time, drawNo: globalDrawCount };
    drawRecords.push(record);

    sendRecord(record);

    const line = `#${globalDrawCount} ğŸ‰ <b>${userID}</b> æŠ½ä¸­ / won: <b>${prize}</b> <span class="muted">(${gmt8Time})</span>`;
    const div = document.createElement('div'); div.innerHTML = line;
    const result = document.getElementById("result"); result.prepend(div); result.scrollTop = 0;
  }

  // â€”â€” ä¸ŠæŠ¥åˆ° Google Sheetsï¼ˆsendBeacon ä¼˜å…ˆï¼Œfetch å…œåº•ï¼‰ â€”â€”
  function sendRecord(payload) {
    const debug = document.getElementById('debugMode').checked;
    const statusEl = document.getElementById('lastStatus');
    const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

    let sent = false;
    if (navigator.sendBeacon) {
      sent = navigator.sendBeacon(googleScriptURL, blob);
      if (debug) console.log('sendBeacon sent=', sent, payload);
      statusEl.textContent = 'å·²å‘é€ï¼ˆsendBeaconï¼‰';
    }
    if (!sent) {
      fetch(googleScriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(()=>{ if (debug) console.log('fetch sent', payload); statusEl.textContent = 'å·²å‘é€ï¼ˆfetchï¼‰'; })
        .catch(err=>{ if (debug) console.error('fetch error', err); statusEl.textContent = 'å‘é€å¤±è´¥ï¼ˆè§æ§åˆ¶å°ï¼‰'; });
    }
  }

  // â€”â€” å¯¼å‡º CSV â€”â€”
  function exportToCSV(){
    let csv = 'åºå·,IDå·,å¥–é¡¹,æŠ½å¥–æ—¶é—´ (GMT+8)\n';
    drawRecords.forEach((r)=>{ csv += `${r.drawNo},${r.userID},${r.prize},${r.time}\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'æŠ½å¥–è®°å½•.csv';
    document.body.appendChild(link); link.click(); link.remove();
  }
</script>
</body>
</html>
